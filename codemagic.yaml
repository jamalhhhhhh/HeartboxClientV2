workflows:
  dylib-inject:
    name: Build Dylib & Inject into IPA
    max_build_duration: 60
    environment:
      vars:
        TARGET_BUNDLE_ID: "com.example.targetapp"
      xcode: latest
      cocoapods: default

    scripts:
      - name: Install Theos
        script: |
          set -e
          export THEOS=$HOME/theos

          # Clone Theos
          if [ ! -d "$THEOS" ]; then
            git clone --recursive https://github.com/theos/theos.git $THEOS
          fi

          # Use Xcode's built-in SDK (already on Codemagic Mac machines - no download needed)
          XCODE_SDK=$(xcrun --sdk iphoneos --show-sdk-path 2>/dev/null || true)
          SDK_DIR=$THEOS/sdks
          mkdir -p $SDK_DIR

          if [ -n "$XCODE_SDK" ]; then
            SDK_NAME=$(basename $XCODE_SDK)
            if [ ! -e "$SDK_DIR/$SDK_NAME" ]; then
              echo "[*] Linking Xcode SDK: $SDK_NAME"
              ln -sf "$XCODE_SDK" "$SDK_DIR/$SDK_NAME"
            fi
            echo "[✓] Using SDK: $SDK_NAME"
          else
            echo "[!] Could not find Xcode SDK"
            exit 1
          fi

          # Write THEOS to env for subsequent steps
          echo "THEOS=$HOME/theos" >> $CM_ENV
          echo "[✓] Theos installed. SDKs:"
          ls $SDK_DIR

      - name: Install inject_dylib
        script: |
          set -e
          brew install ldid 2>/dev/null || true

          if ! command -v insert_dylib &>/dev/null; then
            git clone https://github.com/tyilo/insert_dylib.git /tmp/insert_dylib
            cd /tmp/insert_dylib
            xcodebuild -configuration Release SYMROOT=/tmp/insert_dylib/build 2>/dev/null
            BUILT=$(find /tmp/insert_dylib/build -name "insert_dylib" -type f | head -1)
            cp "$BUILT" /usr/local/bin/insert_dylib
            chmod +x /usr/local/bin/insert_dylib
            echo "[✓] insert_dylib installed"
          fi

      - name: Build Dylib
        script: |
          set -e
          export THEOS=$HOME/theos
          export THEOS_MAKE_PATH=$THEOS/makefiles
          cd $CM_BUILD_DIR
          make -j$(sysctl -n hw.ncpu) 2>&1
          echo "[*] Built artifacts:"
          find . -name "*.dylib" | head -10

      - name: Inject Dylib into IPA
        script: |
          set -e
          cd $CM_BUILD_DIR
          DYLIB_PATH=$(find . -name "MyTweak.dylib" | head -1)
          echo "[*] Found dylib: $DYLIB_PATH"

          IPA_PATH=$(find . -name "*.ipa" | grep -v patched | head -1)
          if [ -z "$IPA_PATH" ]; then
            echo "[!] No IPA found. Add your .ipa file to the repo root."
            exit 1
          fi
          echo "[*] Target IPA: $IPA_PATH"

          chmod +x inject.sh
          bash inject.sh "$IPA_PATH" "$DYLIB_PATH"

      - name: Re-sign IPA (ad-hoc)
        script: |
          set -e
          cd $CM_BUILD_DIR
          PATCHED_IPA=$(find . -name "patched_*.ipa" | head -1)
          WORK_DIR=$(mktemp -d)
          unzip -q "$PATCHED_IPA" -d "$WORK_DIR"
          APP_PATH=$(find "$WORK_DIR/Payload" -name "*.app" | head -1)

          find "$APP_PATH" \( -name "*.dylib" -o -name "*.framework" \) -exec codesign --force --sign - {} \;
          codesign --force --sign - --entitlements /dev/null "$APP_PATH"

          IPA_NAME=$(basename "$PATCHED_IPA")
          cd "$WORK_DIR"
          zip -qr "${OLDPWD}/signed_${IPA_NAME}" Payload
          cd "$OLDPWD"
          rm -rf "$WORK_DIR"
          echo "[✓] Re-signed IPA: signed_${IPA_NAME}"

    artifacts:
      - "**/*.dylib"
      - "**/patched_*.ipa"
      - "**/signed_*.ipa"
